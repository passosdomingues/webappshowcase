<!--
 * --------------------------------------------------------------
 * Author: Rafael Passos Domingues
 * Last Update: 2025 June 6
 * --------------------------------------------------------------
-->

<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üå± PlantAI - Gest√£o Agr√≠cola Inteligente</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet Draw CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  :root {
    --primary: #2f855a;
    --secondary: #38a169;
    --accent: #dd6b20;
    --text: #2d3748;
    --light: #f7fafc;
    --white: #ffffff;
    --warning: #dd6b20;
    --success: #38a169;
    --error: #e53e3e;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--light);
    color: var(--text);
    line-height: 1.6;
    padding: 1rem;
  }
  
  .app-container {
    max-width: 1199.99px;
    margin: 0 auto;
  }
  
  header {
    text-align: center;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--white);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  h1 {
    color: var(--primary);
    font-size: 1.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .status-bar {
    background: var(--white);
    padding: 0.8rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
  }
  
  .grid-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  
  .panel {
    background: var(--white);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1.2rem;
    margin-bottom: 1rem;
  }
  
  .panel-title {
    color: var(--primary);
    font-size: 1.2rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  #map {
    height: 500px;
    width: 100%;
    border-radius: 12px;
    z-index: 1;
  }
  
  .map-container {
    position: relative;
  }
  
  .map-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: var(--white);
    padding: 0.5rem;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }
  
  .btn {
    background: var(--primary);
    color: var(--white);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    transition: all 0.19s;
  }
  
  .btn:hover {
    background: var(--secondary);
    transform: translateY(-1px);
  }
  
  .btn-sm {
    padding: 0.3rem 0.6rem;
    font-size: 0.79rem;
  }
  
  .btn-warning {
    background: var(--warning);
  }
  
  .btn-success {
    background: var(--success);
  }
  
  select, input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #cbd5e0;
    border-radius: 5px;
    margin-bottom: 1rem;
  }
  
  .metrics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .metric-card {
    background: #f0fff4;
    padding: 0.8rem;
    border-radius: 8px;
    border-left: 4px solid var(--primary);
  }
  
  .metric-value {
    font-size: 1.3rem;
    font-weight: bold;
    color: var(--primary);
  }
  
  .metric-label {
    font-size: 0.8rem;
    color: #4a5568;
  }
  
  .alert {
    padding: 0.8rem;
    border-radius: 5px;
    margin: 0.5rem 0;
    border-left: 4px solid;
  }
  
  .alert-warning {
    background: #fffaf0;
    border-left-color: var(--warning);
  }
  
  .alert-success {
    background: #f0fff4;
    border-left-color: var(--success);
  }
  
  .alert-error {
    background: #fff5f5;
    border-left-color: var(--error);
  }
  
  .crop-info {
    line-height: 1.6;
  }
  
  .action-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }
  
  .irrigation-calculator {
    margin-top: 1rem;
    padding: 1rem;
    background: #f0f9ff;
    border-radius: 8px;
  }
  
  @media (max-width: 768px) {
    .grid-container {
      grid-template-columns: 1fr;
    }
    
    #map {
      height: 350px;
    }
    
    .metrics-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
  <div class="app-container">
    <header>
      <h1>üå± PlantAI - Gest√£o Agr√≠cola Inteligente</h1>
      <p>Solu√ß√£o completa para mapeamento e gest√£o de irriga√ß√£o</p>
    </header>
    
    <div class="status-bar">
      <i class="fas fa-map-marker-alt"></i>
      <span id="status-text">Obtendo sua localiza√ß√£o...</span>
    </div>
    
    <div class="grid-container">
      <div class="map-panel">
        <div class="panel">
          <h2 class="panel-title"><i class="fas fa-map-marked-alt"></i> Mapeamento da √Årea</h2>
          <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
              <button id="drawPolygon" class="btn btn-sm" title="Marcar √°rea fechada">
                <i class="fas fa-draw-polygon"></i> Pol√≠gono
              </button>
              <button id="drawPolyline" class="btn btn-sm btn-secondary" title="Marcar √°rea aberta">
                <i class="fas fa-draw-polygon"></i> Linha
              </button>
              <button id="clearAll" class="btn btn-sm btn-warning" title="Limpar tudo">
                <i class="fas fa-trash-alt"></i> Limpar
              </button>
            </div>
          </div>
          
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value" id="areaValue">0 m¬≤</div>
              <div class="metric-label">√Årea total</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="perimeterValue">0 m</div>
              <div class="metric-label">Per√≠metro</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="volumeValue">0 m¬≥</div>
              <div class="metric-label">Volume de terra</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="plantsValue">0</div>
              <div class="metric-label">Plantas estimadas</div>
            </div>
          </div>
          
          <div class="irrigation-calculator">
            <h3><i class="fas fa-tint"></i> C√°lculo de Irriga√ß√£o</h3>
            <div id="irrigationResult">
              <p>Marque uma √°rea e selecione uma cultura para calcular a irriga√ß√£o necess√°ria.</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="info-panel">
        <div class="panel">
          <h2 class="panel-title"><i class="fas fa-cloud-sun"></i> Dados Clim√°ticos</h2>
          <div id="weatherInfo">
            <div class="alert">
              <i class="fas fa-sync-alt fa-spin"></i> Carregando dados meteorol√≥gicos...
            </div>
          </div>
        </div>
        
        <div class="panel">
          <h2 class="panel-title"><i class="fas fa-tractor"></i> Gest√£o de Culturas</h2>
          <label for="crop"><i class="fas fa-seedling"></i> Selecione a cultura:</label>
          <select id="crop">
            <option value="">-- Selecione --</option>
            <option value="cafe">‚òï Caf√©</option>
            <option value="milho">üåΩ Milho</option>
            <option value="soja">ü•ú Soja</option>
            <option value="feijao">ü•ú Feij√£o</option>
            <option value="algodao">üß∂ Algod√£o</option>
            <option value="hortalicas">ü•¶ Hortali√ßas</option>
            <option value="frutiferas">üçä Frut√≠feras</option>
          </select>
          
          <div id="cropInfo" class="crop-info">
            <p>Selecione uma cultura para ver recomenda√ß√µes espec√≠ficas.</p>
          </div>
          
          <div class="action-buttons">
            <button id="exportPdf" class="btn">
              <i class="fas fa-file-pdf"></i> Exportar PDF
            </button>
            <button id="shareWhatsapp" class="btn btn-success">
              <i class="fab fa-whatsapp"></i> Compartilhar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Leaflet Draw -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  
  <!-- Turf.js -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Configura√ß√£o inicial
    const { jsPDF } = window.jspdf;
    
    // Elementos DOM
    const statusText = document.getElementById('status-text');
    const mapElement = document.getElementById('map');
    const drawPolygonBtn = document.getElementById('drawPolygon');
    const drawPolylineBtn = document.getElementById('drawPolyline');
    const clearAllBtn = document.getElementById('clearAll');
    const areaValue = document.getElementById('areaValue');
    const perimeterValue = document.getElementById('perimeterValue');
    const volumeValue = document.getElementById('volumeValue');
    const plantsValue = document.getElementById('plantsValue');
    const cropSelect = document.getElementById('crop');
    const cropInfo = document.getElementById('cropInfo');
    const weatherInfo = document.getElementById('weatherInfo');
    const irrigationResult = document.getElementById('irrigationResult');
    const exportPdfBtn = document.getElementById('exportPdf');
    const shareWhatsappBtn = document.getElementById('shareWhatsapp');

    // Vari√°veis globais
    let map;
    let drawnItems = new L.FeatureGroup();
    let userLocation = null;
    let currentCrop = null;
    let currentArea = 0;
    let weatherData = null;

    // Inicializa√ß√£o do mapa
    function initMap(lat, lon) {
      map = L.map('map').setView([lat, lon], 15);
      
      // Camadas base
      const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      });
      
      const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
      });
      
      osmLayer.addTo(map);
      
      // Controle de camadas
      const baseLayers = {
        "Mapa": osmLayer,
        "Sat√©lite": satelliteLayer
      };
      
      L.control.layers(baseLayers).addTo(map);
      
      // Configura√ß√£o do desenho
      const drawControl = new L.Control.Draw({
        draw: {
          polygon: {
            allowIntersection: false,
            shapeOptions: {
              color: '#2f855a',
              fillOpacity: 0.3
            }
          },
          polyline: {
            shapeOptions: {
              color: '#dd6b20',
              weight: 4
            }
          },
          rectangle: false,
          circle: false,
          marker: false,
          circlemarker: false
        },
        edit: {
          featureGroup: drawnItems
        }
      });
      
      map.addControl(drawControl);
      map.addLayer(drawnItems);
      
      // Eventos de desenho
      map.on(L.Draw.Event.CREATED, function(e) {
        const layer = e.layer;
        drawnItems.addLayer(layer);
        updateMetrics(layer);
        
        const type = e.layerType;
        const area = type === 'polygon' ? turf.area(layer.toGeoJSON()) : 0;
        const length = type === 'polyline' ? turf.length(layer.toGeoJSON(), {units: 'meters'}) : 0;
        
        layer.bindPopup(`
          <b>${type === 'polygon' ? '√Årea' : 'Linha'}</b><br>
          ${type === 'polygon' ? `√Årea: ${area.toFixed(0)} m¬≤` : `Comprimento: ${length.toFixed(0)} m`}
        `).openPopup();
      });
      
      map.on(L.Draw.Event.EDITED, function(e) {
        const layers = e.layers;
        layers.eachLayer(function(layer) {
          updateMetrics(layer);
        });
      });
      
      map.on(L.Draw.Event.DELETED, function() {
        if (drawnItems.getLayers().length === 0) {
          resetMetrics();
        }
      });
      
      // Marcador de localiza√ß√£o
      const greenIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/447/447031.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });
      
      L.marker([lat, lon], {icon: greenIcon}).addTo(map)
        .bindPopup(`<b>Sua localiza√ß√£o</b><br>Lat: ${lat.toFixed(4)}<br>Lon: ${lon.toFixed(4)}`)
        .openPopup();
    }
    
    // Atualiza m√©tricas
    function updateMetrics(layer) {
      const geoJson = layer.toGeoJSON();
      const type = layer instanceof L.Polygon ? 'polygon' : 'polyline';
      
      if (type === 'polygon') {
        currentArea = turf.area(geoJson);
        const perimeter = turf.length(geoJson, {units: 'meters'});
        const volume = currentArea * 0.3; // 0.3m profundidade
        
        areaValue.textContent = `${currentArea.toFixed(0)} m¬≤ (${(currentArea / 10000).toFixed(2)} ha)`;
        perimeterValue.textContent = `${perimeter.toFixed(0)} m`;
        volumeValue.textContent = `${volume.toFixed(0)} m¬≥`;
        
        if (currentCrop) {
          updatePlantsEstimate(currentArea, currentCrop);
          calculateIrrigation(currentArea, currentCrop);
        }
      } else if (type === 'polyline') {
        const length = turf.length(geoJson, {units: 'meters'});
        perimeterValue.textContent = `${length.toFixed(0)} m`;
      }
    }
    
    // Reseta m√©tricas
    function resetMetrics() {
      currentArea = 0;
      areaValue.textContent = '0 m¬≤';
      perimeterValue.textContent = '0 m';
      volumeValue.textContent = '0 m¬≥';
      plantsValue.textContent = '0';
      irrigationResult.innerHTML = '<p>Marque uma √°rea e selecione uma cultura para calcular a irriga√ß√£o necess√°ria.</p>';
    }
    
    // Atualiza estimativa de plantas
    function updatePlantsEstimate(area, crop) {
      let plants = 0;
      const spacing = {
        cafe: 2.5,    // m¬≤ por planta
        milho: 0.2,
        soja: 0.15,
        feijao: 0.1,
        algodao: 0.2,
        hortalicas: 0.3,
        frutiferas: 4
      };
      
      plants = area / (spacing[crop] || 1);
      plantsValue.textContent = `${plants.toFixed(0)} plantas`;
    }
    
    // Calcula irriga√ß√£o necess√°ria
    function calculateIrrigation(area, crop) {
      const waterNeeds = {
        cafe: 5,       // mm/dia
        milho: 6,
        soja: 5.5,
        feijao: 4.5,
        algodao: 6.5,
        hortalicas: 4,
        frutiferas: 5
      };
      
      const need = waterNeeds[crop] || 5;
      const dailyWater = (need * area) / 1000; // em m¬≥/dia
      const weeklyWater = dailyWater * 7;
      
      irrigationResult.innerHTML = `
        <div class="alert alert-success">
          <i class="fas fa-tint"></i> <strong>Recomenda√ß√£o de Irriga√ß√£o</strong>
          <p>üåßÔ∏è <strong>${need} mm/dia</strong> para ${cropSelect.options[cropSelect.selectedIndex].text}</p>
          <p>üíß <strong>${dailyWater.toFixed(1)} m¬≥/dia</strong> (${weeklyWater.toFixed(1)} m¬≥/semana)</p>
          <p>‚è±Ô∏è <strong>${(dailyWater/10).toFixed(1)} horas/dia</strong> com sistema de 10m¬≥/h</p>
        </div>
      `;
    }
    
    // Busca dados meteorol√≥gicos
    async function fetchWeather(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relativehumidity_2m,precipitation&daily=precipitation_sum&timezone=auto`;
      
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Erro na API");
        return await response.json();
      } catch (error) {
        console.error("Erro ao buscar clima:", error);
        weatherInfo.innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> N√£o foi poss√≠vel obter dados clim√°ticos em tempo real.
          </div>
        `;
        return null;
      }
    }
    
    // Atualiza exibi√ß√£o do clima
    function updateWeatherDisplay(data) {
      if (!data || !data.current_weather) return;
      
      const current = data.current_weather;
      const hourly = data.hourly;
      const timeIndex = hourly.time.findIndex(t => t === current.time);
      
      weatherInfo.innerHTML = `
        <div class="weather-current">
          <h3><i class="fas fa-temperature-high"></i> Condi√ß√µes Atuais</h3>
          <p>üå°Ô∏è <strong>Temperatura:</strong> ${current.temperature}¬∞C</p>
          <p>üíß <strong>Umidade:</strong> ${timeIndex >= 0 ? hourly.relativehumidity_2m[timeIndex] + '%' : '--'}</p>
          <p>üå¨Ô∏è <strong>Vento:</strong> ${current.windspeed} km/h</p>
          <p>üåßÔ∏è <strong>Precipita√ß√£o:</strong> ${timeIndex >= 0 ? hourly.precipitation[timeIndex] + ' mm' : '--'}</p>
        </div>
      `;
    }
    
    // Atualiza informa√ß√µes da cultura
    function updateCropInfo(crop) {
      currentCrop = crop;
      if (!crop) {
        cropInfo.innerHTML = '<p>Selecione uma cultura para ver recomenda√ß√µes.</p>';
        return;
      }
      
      const cropData = {
        cafe: {
          name: '‚òï Caf√©',
          planting: 'Out-Nov (in√≠cio das chuvas)',
          water: '5-7 mm/dia',
          tips: 'Mantenha solo √∫mido durante flora√ß√£o e grana√ß√£o'
        },
        milho: {
          name: 'üåΩ Milho',
          planting: 'Set-Out (safra) ou Jan (safrinha)',
          water: '6-8 mm/dia',
          tips: 'Cr√≠tico no florescimento e enchimento de gr√£os'
        },
        soja: {
          name: 'ü•ú Soja',
          planting: 'Set-Nov conforme regi√£o',
          water: '5-6 mm/dia',
          tips: 'Evite d√©ficit h√≠drico no florescimento'
        },
        feijao: {
          name: 'ü•ú Feij√£o',
          planting: 'Out-Dez ou Fev-Mar',
          water: '4-5 mm/dia',
          tips: 'Irriga√ß√£o uniforme durante o ciclo'
        },
        algodao: {
          name: 'üß∂ Algod√£o',
          planting: 'Nov-Dez',
          water: '6-7 mm/dia',
          tips: 'Maior necessidade na flora√ß√£o e frutifica√ß√£o'
        },
        hortalicas: {
          name: 'ü•¶ Hortali√ßas',
          planting: 'Conforme esp√©cie',
          water: '4-5 mm/dia',
          tips: 'Irriga√ß√µes frequentes em pequenos volumes'
        },
        frutiferas: {
          name: 'üçä Frut√≠feras',
          planting: 'In√≠cio das chuvas',
          water: '5-6 mm/dia',
          tips: 'Boa drenagem √© essencial'
        }
      };
      
      const info = cropData[crop];
      cropInfo.innerHTML = `
        <h3>${info.name}</h3>
        <p>üìÖ <strong>√âpoca de plantio:</strong> ${info.planting}</p>
        <p>üíß <strong>Necessidade h√≠drica:</strong> ${info.water}</p>
        <p>üå± <strong>Dicas:</strong> ${info.tips}</p>
      `;
      
      if (currentArea > 0) {
        updatePlantsEstimate(currentArea, crop);
        calculateIrrigation(currentArea, crop);
      }
    }
    
    // Gera relat√≥rio PDF
    function generatePDF() {
      const doc = new jsPDF();
      
      // Cabe√ßalho
      doc.setFontSize(18);
      doc.setTextColor(47, 133, 90);
      doc.text('üå± PlantAI - Relat√≥rio Agr√≠cola', 105, 15, { align: 'center' });
      
      // Dados da cultura
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Cultura: ${cropSelect.options[cropSelect.selectedIndex].text}`, 15, 30);
      doc.text(`√Årea: ${areaValue.textContent}`, 15, 40);
      doc.text(`Plantas estimadas: ${plantsValue.textContent}`, 15, 50);
      
      // Recomenda√ß√µes de irriga√ß√£o
      const irrigationText = irrigationResult.textContent.split('\n').filter(t => t.trim());
      doc.text('Recomenda√ß√µes de Irriga√ß√£o:', 15, 65);
      irrigationText.forEach((line, i) => {
        doc.text(line.trim(), 20, 75 + (i * 7));
      });
      
      // Data e localiza√ß√£o
      doc.text(`Data: ${new Date().toLocaleDateString()}`, 15, 120);
      if (userLocation) {
        doc.text(`Localiza√ß√£o: Lat ${userLocation.lat.toFixed(4)}, Lon ${userLocation.lon.toFixed(4)}`, 15, 130);
      }
      
      doc.save('relatorio_plantai.pdf');
    }
    
    // Compartilha via WhatsApp
    function shareViaWhatsApp() {
      const cropName = cropSelect.options[cropSelect.selectedIndex].text;
      const areaText = areaValue.textContent;
      const plantsText = plantsValue.textContent;
      const irrigationText = irrigationResult.textContent.split('\n')
        .filter(t => t.trim())
        .map(t => t.trim())
        .join('%0A- ');
      
      const text = `*Relat√≥rio PlantAI*%0A%0A` +
        `*Cultura:* ${cropName}%0A` +
        `*√Årea:* ${areaText}%0A` +
        `*Plantas:* ${plantsText}%0A%0A` +
        `*Recomenda√ß√µes:*%0A- ${irrigationText}%0A%0A` +
        `_Gerado em ${new Date().toLocaleDateString()}_`;
      
      window.open(`https://wa.me/?text=${text}`, '_blank');
    }
    
    // Inicializa√ß√£o do app
    async function initApp() {
      try {
        // Obt√©m localiza√ß√£o
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          });
        });
        
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        userLocation = { lat, lon };
        
        statusText.textContent = `Localiza√ß√£o: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        
        // Inicializa mapa
        initMap(lat, lon);
        
        // Busca dados clim√°ticos
        weatherData = await fetchWeather(lat, lon);
        updateWeatherDisplay(weatherData);
        
        // Configura eventos
        drawPolygonBtn.addEventListener('click', () => {
          new L.Draw.Polygon(map, L.Draw.Polygon.prototype.options).enable();
        });
        
        drawPolylineBtn.addEventListener('click', () => {
          new L.Draw.Polyline(map, L.Draw.Polyline.prototype.options).enable();
        });
        
        clearAllBtn.addEventListener('click', () => {
          drawnItems.clearLayers();
          resetMetrics();
        });
        
        cropSelect.addEventListener('change', () => {
          updateCropInfo(cropSelect.value);
        });
        
        exportPdfBtn.addEventListener('click', generatePDF);
        shareWhatsappBtn.addEventListener('click', shareViaWhatsApp);
        
      } catch (error) {
        console.error("Erro na geolocaliza√ß√£o:", error);
        
        // Fallback para localiza√ß√£o padr√£o (Bras√≠lia)
        const defaultLat = -15.7975;
        const defaultLon = -47.8919;
        userLocation = { lat: defaultLat, lon: defaultLon };
        
        statusText.textContent = "Localiza√ß√£o padr√£o (Bras√≠lia)";
        initMap(defaultLat, defaultLon);
        
        weatherInfo.innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> Usando localiza√ß√£o padr√£o.
          </div>
        `;
      }
    }
    
    // Inicia o aplicativo
    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>