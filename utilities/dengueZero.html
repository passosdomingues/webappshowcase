<!--
 * --------------------------------------------------------------
 * Author: Rafael Passos Domingues
 * Last Update: 2025 June 7
 * --------------------------------------------------------------
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DengueZero - Sistema de Report de Focos de Dengue</title>
<!-- Bibliotecas externas -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  :root {
    /* Cores principais atualizadas para tema de sa√∫de */
    --primary-color: #27ae60;       /* Verde para elementos prim√°rios */
    --primary-dark: #219653;        /* Verde mais escuro para hover */
    --danger-color: #e74c3c;        /* Vermelho para alertas graves */
    --warning-color: #f39c12;       /* Laranja para alertas m√©dios */
    --info-color: #3498db;          /* Azul claro para informa√ß√µes */
    --success-color: #2ecc71;       /* Verde para elementos positivos */
    --text-color: #333;             /* Cor principal do texto */
    --light-gray: #f5f5f5;          /* Cor de fundo */
    --border-radius: 8px;           /* Arredondamento de bordas */
    --box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Sombra padr√£o */
  }
  
  body {
    font-family: 'Segoe UI', Roboto, Arial, sans-serif;
    margin: 0;
    padding: 1rem;
    background: var(--light-gray);
    color: var(--text-color);
    line-height: 1.6;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  h1 {
    margin: 0;
    color: var(--primary-color);
    font-size: 1.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  #map {
    height: 500px;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
    box-shadow: var(--box-shadow);
    border: 1px solid #ddd;
  }
  
  .info-panel {
    background: white;
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
    box-shadow: var(--box-shadow);
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: space-between;
    align-items: center;
  }
  
  .alert {
    color: var(--danger-color);
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .status-info {
    display: flex;
    gap: 1rem;
  }
  
  .status-item {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.9rem;
  }
  
  .button-group {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }
  
  button {
    padding: 0.8rem 1.2rem;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 599.0042;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
  }
  
  .btn-primary {
    background: var(--primary-color);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
  }
  
  .btn-danger {
    background: var(--danger-color);
    color: white;
  }
  
  .btn-danger:hover {
    background: #c0392b;
    transform: translateY(-2px);
  }
  
  .btn-accent {
    background: var(--info-color);
    color: white;
  }
  
  .btn-accent:hover {
    background: #2980b9;
    transform: translateY(-2px);
  }
  
  .btn-outline {
    background: transparent;
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
  }
  
  .btn-outline:hover {
    background: var(--primary-color);
    color: white;
  }
  
  .legend {
    background: white;
    padding: 1rem;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    position: absolute;
    bottom: 30px;
    right: 10px;
    z-index: 1000;
    font-size: 0.9rem;
    max-width: 199px;
  }
  
  .legend h3 {
    margin-top: 0;
    margin-bottom: 0.8rem;
    font-size: 1rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    gap: 0.5rem;
  }
  
  .legend-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.8rem;
  }
  
  /* Painel de sele√ß√£o de focos */
  .incident-panel {
    background: white;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
    box-shadow: var(--box-shadow);
    display: none;
    position: relative;
    z-index: 1001;
  }
  
  .incident-types {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.8rem;
    margin: 1rem 0;
  }
  
  .incident-type {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid #ddd;
  }
  
  .incident-type:hover {
    background: #f8f9fa;
  }
  
  .incident-type input {
    margin: 0;
  }
  
  /* Cores de gravidade */
  .incident-type.grave {
    border-left: 4px solid var(--danger-color);
  }
  
  .incident-type.media {
    border-left: 4px solid var(--warning-color);
  }
  
  .incident-type.leve {
    border-left: 4px solid var(--info-color);
  }
  
  /* Campo de descri√ß√£o para focos "outros" */
  .other-description {
    display: none;
    margin-top: 1rem;
  }
  
  .other-description textarea {
    width: 100%;
    min-height: 80px;
    padding: 0.8rem;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-family: inherit;
  }
  
  /* Estilo para fotos */
  .photo-container {
    display: none;
    margin-top: 1rem;
  }
  
  .photo-preview {
    max-width: 100%;
    max-height: 199px;
    margin-top: 0.5rem;
    border-radius: var(--border-radius);
    display: none;
  }
  
  @media (max-width: 768px) {
    header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .info-panel {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .button-group {
      flex-direction: column;
    }
    
    .legend {
      position: relative;
      bottom: auto;
      right: auto;
      margin-top: 1rem;
      max-width: 100%;
    }
    
    #map {
      height: 400px;
    }
    
    .incident-types {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>

<div class="container">
  <!-- Cabe√ßalho com t√≠tulo e informa√ß√µes de status -->
  <header>
    <h1>
    <img src="https://rpassosdomingues.github.io/insights/icons/dengue.png" alt="Dengue Icon" style="height: 1em; vertical-align: middle;">
  DengueZero
    </h1>
    <div class="status-info">
      <div class="status-item">
        <i class="fas fa-map-marker-alt" style="color: var(--danger-color);"></i>
        <span>Focos: <strong id="contador">0</strong></span>
      </div>
      <div class="status-item">
        <i class="far fa-clock" style="color: var(--primary-color);"></i>
        <span id="hora-atual">--:--:--</span>
      </div>
    </div>
  </header>

  <!-- Painel de informa√ß√µes principais -->
  <div class="info-panel">
    <p class="alert"><i class="fas fa-exclamation-triangle"></i> Clique no mapa para registrar focos de dengue encontrados</p>
    <button class="btn-primary" onclick="mostrarPainelIncidentes()">
      <i class="fas fa-plus-circle"></i> Registrar Foco
    </button>
  </div>

  <!-- Painel de sele√ß√£o de tipos de focos -->
  <div class="incident-panel" id="incidentPanel">
    <h3><i class="fas fa-clipboard-list"></i> Selecione o tipo de foco encontrado:</h3>
    
    <!-- Grid de tipos de focos -->
    <div class="incident-types" id="incidentTypes"></div>

    <!-- Campo para adicionar foto -->
    <div class="photo-container" id="photoContainer">
      <label for="fotoFoco">Adicionar foto do foco (opcional):</label>
      <input type="file" id="fotoFoco" accept="image/*" capture="environment">
      <img id="photoPreview" class="photo-preview" alt="Pr√©-visualiza√ß√£o da foto">
    </div>

    <!-- Campo de descri√ß√£o para focos "outros" -->
    <div class="other-description" id="otherDescription">
      <label for="incidentDetails">Descreva detalhadamente o foco encontrado:</label>
      <textarea id="incidentDetails" placeholder="Descreva o local e as condi√ß√µes do foco de dengue..."></textarea>
    </div>

    <!-- Bot√µes de a√ß√£o do painel -->
    <div class="button-group">
      <button class="btn-primary" onclick="confirmarSelecao()">
        <i class="fas fa-check"></i> Confirmar
      </button>
      <button class="btn-outline" onclick="fecharPainelIncidentes()">
        <i class="fas fa-times"></i> Cancelar
      </button>
    </div>
  </div>

  <!-- Mapa Leaflet -->
  <div id="map"></div>

  <!-- Legenda do mapa -->
  <div class="legend">
    <h3><i class="fas fa-key"></i> Legenda</h3>
    <div class="legend-item">
      <span class="legend-icon" style="background: #2ecc70;"><i class="fas fa-user"></i></span>
      <span>Sua posi√ß√£o</span>
    </div>
    <div class="legend-item">
      <span class="legend-icon" style="background: #e74c3c;"><i class="fas fa-skull-crossbones"></i></span>
      <span>Foco cr√≠tico</span>
    </div>
    <div class="legend-item">
      <span class="legend-icon" style="background: #f39c12;"><i class="fas fa-exclamation-triangle"></i></span>
      <span>Foco m√©dio</span>
    </div>
    <div class="legend-item">
      <span class="legend-icon" style="background: #3498db;"><i class="fas fa-info-circle"></i></span>
      <span>Foco pequeno</span>
    </div>
    <div class="legend-item">
      <span class="legend-icon" style="background: #9b59b6;"><i class="fas fa-question-circle"></i></span>
      <span>Outro tipo</span>
    </div>
  </div>

  <!-- Bot√µes de a√ß√£o -->
  <div class="button-group">
    <button class="btn-primary" onclick="exportarWhatsApp()">
      <i class="fab fa-whatsapp"></i> Compartilhar via WhatsApp
    </button>
    <button class="btn-accent" onclick="exportarRelatorio()">
      <i class="fas fa-file-export"></i> Exportar Relat√≥rio
    </button>
    <button class="btn-danger" onclick="limparRegistros()">
      <i class="fas fa-trash-alt"></i> Limpar Registros
    </button>
  </div>
</div>

<!-- Bibliotecas JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script>
  /**
   * VARI√ÅVEIS GLOBAIS
   */
  const focos = []; // Armazena todos os focos registrados
  let map; // Objeto do mapa Leaflet
  let usuarioMarcador; // Marcador da posi√ß√£o do usu√°rio
  let currentLatLng = null; // √öltima posi√ß√£o clicada no mapa
  let fotoData = null; // Armazena a foto em base64

  // Tipos de focos de dengue com classifica√ß√£o de gravidade
  const incidentTypes = [
    // Focos cr√≠ticos (vermelho)
    { id: 'agua-parada', name: '√Ågua parada grande', severity: 'grave', icon: 'water' },
    { id: 'pneus', name: 'Pneus com √°gua', severity: 'grave', icon: 'tire' },
    { id: 'lixo', name: 'Lixo acumulado', severity: 'grave', icon: 'trash' },
    { id: 'vasos', name: 'Vasos com √°gua', severity: 'grave', icon: 'flower' },
    { id: 'calhas', name: 'Calhas entupidas', severity: 'grave', icon: 'gutter' },
    
    // Focos m√©dios (laranja)
    { id: 'garrafas', name: 'Garrafas abertas', severity: 'media', icon: 'wine-bottle' },
    { id: 'lajes', name: 'Lajes com √°gua', severity: 'media', icon: 'building' },
    { id: 'bebedouros', name: 'Bebedouros animais', severity: 'media', icon: 'paw' },
    { id: 'piscinas', name: 'Piscinas n√£o tratadas', severity: 'media', icon: 'swimming-pool' },
    
    // Focos pequenos (azul)
    { id: 'pratos', name: 'Pratos de plantas', severity: 'leve', icon: 'utensils' },
    { id: 'pocas', name: 'Po√ßas pequenas', severity: 'leve', icon: 'tint' },
    { id: 'baldes', name: 'Baldes com √°gua', severity: 'leve', icon: 'bucket' },
    
    // Outros (usu√°rio define descri√ß√£o)
    { id: 'outro', name: 'Outro tipo de foco', severity: null, icon: 'question-circle' }
  ];

  let selectedIncidentTypes = []; // Tipos selecionados no painel

  /**
   * FUN√á√ïES DE INTERFACE
   */

  // Atualiza contador de focos na interface
  function atualizarContador() {
    document.getElementById('contador').textContent = focos.length;
  }

  // Atualiza rel√≥gio em tempo real
  function atualizarRelogio() {
    const agora = new Date();
    const horas = String(agora.getHours()).padStart(2, '0');
    const minutos = String(agora.getMinutes()).padStart(2, '0');
    const segundos = String(agora.getSeconds()).padStart(2, '0');
    document.getElementById('hora-atual').textContent = `${horas}:${minutos}:${segundos}`;
  }

  // Formata data/hora para formato leg√≠vel
  function formatarTimestamp(data) {
    const d = new Date(data);
    const dia = String(d.getDate()).padStart(2, '0');
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const ano = d.getFullYear();
    const hora = String(d.getHours()).padStart(2, '0');
    const min = String(d.getMinutes()).padStart(2, '0');
    return `${dia}/${mes}/${ano} ${hora}:${min}`;
  }

  // Mostra o painel de sele√ß√£o de focos
  function mostrarPainelIncidentes() {
    document.getElementById('incidentPanel').style.display = 'block';
    document.getElementById('otherDescription').style.display = 'none';
    document.getElementById('photoContainer').style.display = 'block';
    document.getElementById('photoPreview').style.display = 'none';
    selectedIncidentTypes = [];
    fotoData = null;
    
    // Configura o input de foto
    document.getElementById('fotoFoco').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          fotoData = event.target.result;
          const preview = document.getElementById('photoPreview');
          preview.src = fotoData;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
    
    // Desmarca todas as sele√ß√µes anteriores
    document.querySelectorAll('#incidentTypes input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  // Fecha o painel de sele√ß√£o de focos
  function fecharPainelIncidentes() {
    document.getElementById('incidentPanel').style.display = 'none';
    document.getElementById('fotoFoco').value = '';
  }

  // Carrega os tipos de focos no painel
  function loadIncidentTypes() {
    const container = document.getElementById('incidentTypes');
    container.innerHTML = '';
    
    incidentTypes.forEach(type => {
      const div = document.createElement('div');
      div.className = `incident-type ${type.severity || ''}`;
      div.innerHTML = `
        <input type="checkbox" id="type_${type.id}" value="${type.id}">
        <label for="type_${type.id}">
          <i class="fas fa-${type.icon}"></i> ${type.name}
        </label>
      `;
      
      // Evento para quando um tipo √© selecionado/deselecionado
      div.querySelector('input').addEventListener('change', function() {
        if (this.checked) {
          // Se for "outro", mostra campo de descri√ß√£o
          if (type.id === 'outro') {
            document.getElementById('otherDescription').style.display = 'block';
          }
          selectedIncidentTypes.push(type.id);
        } else {
          // Se for "outro", esconde campo de descri√ß√£o
          if (type.id === 'outro') {
            document.getElementById('otherDescription').style.display = 'none';
            document.getElementById('incidentDetails').value = '';
          }
          selectedIncidentTypes = selectedIncidentTypes.filter(t => t !== type.id);
        }
      });
      
      container.appendChild(div);
    });
  }

  // Confirma a sele√ß√£o e cria o marcador
  async function confirmarSelecao() {
    if (selectedIncidentTypes.length === 0) {
      alert("Selecione pelo menos um tipo de foco.");
      return;
    }

    // Valida√ß√£o para focos "outros"
    if (selectedIncidentTypes.includes('outro')) {
      const details = document.getElementById('incidentDetails').value.trim();
      if (!details) {
        alert("Por favor, descreva detalhadamente o foco encontrado.");
        return;
      }
    }

    // Fecha o painel e cria o marcador
    fecharPainelIncidentes();
    await criarMarcador(currentLatLng);
  }

  /**
   * FUN√á√ïES DO MAPA
   */

  // Busca endere√ßo reverso (de coordenadas para endere√ßo)
  async function buscarEndereco(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
    try {
      const resposta = await fetch(url, { 
        headers: { 
          'Accept-Language': 'pt-BR',
          'User-Agent': 'DengueZero/1.0' 
        }
      });
      const dados = await resposta.json();

      // Extrai dados do endere√ßo
      const endereco = dados.address || {};
      return {
        rua: endereco.road || endereco.pedestrian || endereco.neighbourhood || "Local desconhecido",
        cep: endereco.postcode || "CEP n√£o encontrado",
        bairro: endereco.suburb || endereco.neighbourhood || "Bairro desconhecido",
        cidade: endereco.city || endereco.town || endereco.village || "Cidade desconhecida"
      };
    } catch (erro) {
      console.error("Erro ao buscar endere√ßo:", erro);
      return { 
        rua: "Local desconhecido", 
        cep: "CEP n√£o encontrado",
        bairro: "Bairro desconhecido",
        cidade: "Cidade desconhecida"
      };
    }
  }

  // Retorna √≠cone e cor baseado no tipo e gravidade do foco
  function getIncidentIcon(typeId) {
    const type = incidentTypes.find(t => t.id === typeId);
    
    // Cores baseadas na gravidade
    const colors = {
      'grave': '#e74c3c',    // Vermelho
      'media': '#f39c12',    // Laranja
      'leve': '#3498db'      // Azul
    };
    
    return {
      icon: type ? type.icon : 'exclamation',
      color: type ? colors[type.severity] : '#9b59b6'  // Roxo para indefinido
    };
  }

  // Inicializa o mapa Leaflet
  function iniciarMapa(lat, lng) {
    map = L.map('map').setView([lat, lng], 18); // Zoom 18 para √°reas menores

    // Camada do mapa (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Marcador do usu√°rio (verde)
    usuarioMarcador = L.marker([lat, lng], {
      title: "Sua posi√ß√£o",
      icon: L.divIcon({
        html: '<i class="fas fa-user" style="color: #2ecc70; font-size: 24px;"></i>',
        className: 'user-marker',
        iconSize: [24, 24]
      })
    }).addTo(map);
    
    usuarioMarcador.bindPopup("<b>Sua posi√ß√£o atual</b>").openPopup();

    // Atualiza posi√ß√£o do usu√°rio periodicamente (simula√ß√£o de movimento)
    setInterval(() => {
      navigator.geolocation.getCurrentPosition(pos => {
        const newLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
        usuarioMarcador.setLatLng(newLatLng);
        // Centraliza o mapa se o usu√°rio sair da √°rea vis√≠vel
        if (map.getBounds().contains(newLatLng) === false) {
          map.setView(newLatLng, map.getZoom());
        }
      });
    }, 30000); // Atualiza a cada 30 segundos

    // Evento de clique no mapa para registrar focos
    map.on('click', async e => {
      currentLatLng = e.latlng;
      mostrarPainelIncidentes();
    });
  }

  // Cria um marcador de foco no mapa
  async function criarMarcador(latlng) {
    // Busca endere√ßo pelas coordenadas
    const { rua, cep, bairro, cidade } = await buscarEndereco(latlng.lat, latlng.lng);

    // Determina o tipo principal
    let mainType = selectedIncidentTypes[0];
    if (selectedIncidentTypes.includes('agua-parada')) mainType = 'agua-parada';
    else if (selectedIncidentTypes.includes('pneus')) mainType = 'pneus';
    else if (selectedIncidentTypes.includes('lixo')) mainType = 'lixo';

    // Obt√©m √≠cone e cor para o marcador
    const { icon, color } = getIncidentIcon(mainType);

    // Descri√ß√£o do foco (para "outros" pega do textarea)
    let descricao = '';
    if (selectedIncidentTypes.includes('outro')) {
      descricao = document.getElementById('incidentDetails').value.trim();
    } else {
      // Para outros tipos, pede uma descri√ß√£o complementar
      descricao = prompt(
        `üìù Descreva o foco encontrado em:\n\nüìç Local: ${rua}\nüèòÔ∏è Bairro: ${bairro}\nüèôÔ∏è Cidade: ${cidade}\nüìÆ CEP: ${cep}`,
        selectedIncidentTypes.map(t => {
          const type = incidentTypes.find(it => it.id === t);
          return type ? type.name : '';
        }).join(', ')
      );
      
      if (descricao === null) return; // Usu√°rio cancelou
      if (!descricao) descricao = "Sem descri√ß√£o detalhada";
    }

    const timestamp = new Date();

    // Cria o marcador no mapa com √≠cone personalizado
    const marcador = L.marker(latlng, { 
      draggable: true,
      icon: L.divIcon({
        html: `<i class="fas fa-${icon}" style="color: ${color}; font-size: 24px;"></i>`,
        className: 'incident-marker',
        iconSize: [24, 24]
      })
    }).addTo(map);

    // Texto para os tipos selecionados
    const tiposTexto = selectedIncidentTypes.map(t => {
      const type = incidentTypes.find(it => it.id === t);
      return type ? type.name : '';
    }).filter(t => t).join(', ');

    // Determina a gravidade com base no tipo principal
    const type = incidentTypes.find(t => t.id === mainType);
    const severity = type ? type.severity : 'leve';

    // Conte√∫do do popup do marcador
    let popupContent = `
      <b><i class="fas fa-${icon}"></i> Foco de Dengue:</b><br>
      <small>${formatarTimestamp(timestamp)}</small><br><br>
      <b>üìç Local:</b> ${rua}<br>
      <b>üèòÔ∏è Bairro:</b> ${bairro}<br>
      <b>üèôÔ∏è Cidade:</b> ${cidade}<br>
      <b>üìÆ CEP:</b> ${cep}<br><br>
      <b>‚ö†Ô∏è Tipo(s):</b> ${tiposTexto}<br>
      <b>üìù Descri√ß√£o:</b> ${descricao}<br><br>
    `;

    // Adiciona a foto se existir
    if (fotoData) {
      popupContent += `
        <b>üì∏ Foto:</b><br>
        <img src="${fotoData}" style="max-width: 100%; max-height: 150px; border-radius: 4px;"><br><br>
      `;
    }

    popupContent += `<small>(Arraste para ajustar posi√ß√£o | Delete para remover)</small>`;

    marcador.bindPopup(popupContent).openPopup();

    // Atualiza popup e dados quando o marcador √© movido
    marcador.on('dragend', async () => {
      const pos = marcador.getLatLng();
      const { rua: novaRua, cep: novoCep, bairro: novoBairro, cidade: novaCidade } = await buscarEndereco(pos.lat, pos.lng);
      
      let updatedPopupContent = `
        <b><i class="fas fa-${icon}"></i> Foco de Dengue:</b><br>
        <small>${formatarTimestamp(timestamp)}</small><br><br>
        <b>üìç Local:</b> ${novaRua}<br>
        <b>üèòÔ∏è Bairro:</b> ${novoBairro}<br>
        <b>üèôÔ∏è Cidade:</b> ${novaCidade}<br>
        <b>üìÆ CEP:</b> ${novoCep}<br><br>
        <b>‚ö†Ô∏è Tipo(s):</b> ${tiposTexto}<br>
        <b>üìù Descri√ß√£o:</b> ${descricao}<br><br>
      `;

      if (fotoData) {
        updatedPopupContent += `
          <b>üì∏ Foto:</b><br>
          <img src="${fotoData}" style="max-width: 100%; max-height: 150px; border-radius: 4px;"><br><br>
        `;
      }

      updatedPopupContent += `<small>(Arraste para ajustar posi√ß√£o | Delete para remover)</small>`;

      marcador.setPopupContent(updatedPopupContent).openPopup();

      // Atualiza dados no array de focos
      const index = focos.findIndex(e => e.marcador === marcador);
      if (index !== -1) {
        focos[index].latlng = pos;
        focos[index].rua = novaRua;
        focos[index].cep = novoCep;
        focos[index].bairro = novoBairro;
        focos[index].cidade = novaCidade;
      }
    });

    // Permite remover marcador com tecla Delete
    marcador.on('popupopen', () => {
      document.addEventListener('keydown', function removerMarcador(e) {
        if (e.key === 'Delete') {
          map.removeLayer(marcador);
          const index = focos.findIndex(p => p.marcador === marcador);
          if (index !== -1) {
            focos.splice(index, 1);
            atualizarContador();
          }
          document.removeEventListener('keydown', removerMarcador);
        }
      });
    });

    // Adiciona o foco ao array global
    focos.push({ 
      marcador, 
      latlng, 
      rua, 
      cep, 
      bairro, 
      cidade, 
      descricao, 
      timestamp,
      tipos: selectedIncidentTypes,
      tiposTexto,
      severity,
      foto: fotoData
    });
    
    atualizarContador();
    selectedIncidentTypes = []; // Reseta sele√ß√£o
    fotoData = null; // Limpa a foto
    document.getElementById('fotoFoco').value = ''; // Limpa o input de foto
    document.getElementById('photoPreview').style.display = 'none'; // Esconde a pr√©-visualiza√ß√£o
  }

  /**
   * FUN√á√ïES DE EXPORTA√á√ÉO
   */

  // Exporta relat√≥rio para WhatsApp
  function exportarWhatsApp() {
    if (focos.length === 0) {
      alert("Nenhum foco registrado.");
      return;
    }

    let texto = "ü¶ü *Relat√≥rio de Focos de Dengue*\n\n";
    
    // Cabe√ßalho
    texto += `üõ°Ô∏è *Relat√≥rio de Inspe√ß√£o*\n`;
    texto += `üë§ *Agente:* [Seu Nome]\n`;
    texto += `üìÖ *Data:* ${formatarTimestamp(new Date())}\n\n`;
    
    // Resumo por gravidade
    const resumoGravidade = { grave: 0, media: 0, leve: 0 };
    focos.forEach(foco => {
      resumoGravidade[foco.severity]++;
    });
    
    texto += `üìä *Resumo por Gravidade:*\n`;
    texto += `   üî¥ Cr√≠tico: ${resumoGravidade.grave}\n`;
    texto += `   üü† M√©dio: ${resumoGravidade.media}\n`;
    texto += `   üîµ Leve: ${resumoGravidade.leve}\n\n`;
    
    // Detalhes dos focos
    texto += `üîç *Detalhes dos Focos:*\n\n`;
    focos.forEach((foco, i) => {
      texto += `üìç *Foco ${i + 1}:*\n`;
      texto += `   üè∑Ô∏è Tipo(s): ${foco.tiposTexto}\n`;
      texto += `   ${foco.severity === 'grave' ? 'üî¥' : foco.severity === 'media' ? 'üü†' : 'üîµ'} Gravidade: ${foco.severity}\n`;
      texto += `   üè† Local: ${foco.rua}\n`;
      texto += `   üèòÔ∏è Bairro: ${foco.bairro}\n`;
      texto += `   üèôÔ∏è Cidade: ${foco.cidade}\n`;
      texto += `   üìÆ CEP: ${foco.cep}\n`;
      texto += `   ‚ö†Ô∏è Descri√ß√£o: ${foco.descricao}\n`;
      texto += `   üïí Hor√°rio: ${formatarTimestamp(foco.timestamp)}\n`;
      texto += `   üìç Coordenadas: (Lat: ${foco.latlng.lat.toFixed(5)}, Lng: ${foco.latlng.lng.toFixed(5)})\n\n`;
    });

    texto += "\n‚ö†Ô∏è *Aten√ß√£o:* Verificar todos os focos reportados e tomar as provid√™ncias necess√°rias para elimina√ß√£o.";

    // Abre o WhatsApp com o texto formatado
    const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
    window.open(url, '_blank');
  }

  // Exporta relat√≥rio completo para texto
  function exportarRelatorio() {
    if (focos.length === 0) {
      alert("Nenhum foco registrado.");
      return;
    }

    let texto = "=== RELAT√ìRIO DE FOCOS DE DENGUE ===\n\n";
    texto += `Agente: [Seu Nome]\n`;
    texto += `Data do relat√≥rio: ${formatarTimestamp(new Date())}\n\n`;
    
    // Resumo por gravidade
    const resumoGravidade = { grave: 0, media: 0, leve: 0 };
    focos.forEach(foco => {
      resumoGravidade[foco.severity]++;
    });
    
    texto += "RESUMO POR GRAVIDADE:\n";
    texto += `- Cr√≠tico: ${resumoGravidade.grave}\n`;
    texto += `- M√©dio: ${resumoGravidade.media}\n`;
    texto += `- Leve: ${resumoGravidade.leve}\n\n`;
    
    // Detalhes dos focos
    texto += "DETALHES DOS FOCOS:\n\n";
    focos.forEach((foco, i) => {
      texto += `FOCO ${i + 1}:\n`;
      texto += `- Tipo(s): ${foco.tiposTexto}\n`;
      texto += `- Gravidade: ${foco.severity}\n`;
      texto += `- Local: ${foco.rua}\n`;
      texto += `- Bairro: ${foco.bairro}\n`;
      texto += `- Cidade: ${foco.cidade}\n`;
      texto += `- CEP: ${foco.cep}\n`;
      texto += `- Descri√ß√£o: ${foco.descricao}\n`;
      texto += `- Hor√°rio: ${formatarTimestamp(foco.timestamp)}\n`;
      texto += `- Coordenadas: (Lat: ${foco.latlng.lat.toFixed(5)}, Lng: ${foco.latlng.lng.toFixed(5)})\n\n`;
    });

    texto += "\nOBSERVA√á√ïES: Verificar todos os focos reportados e tomar as provid√™ncias necess√°rias para elimina√ß√£o.";

    // Cria e faz download do arquivo de texto
    const blob = new Blob([texto], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `relatorio_dengue_${new Date().toISOString().slice(0,10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Limpa todos os registros
  function limparRegistros() {
    if (focos.length === 0 || confirm("Tem certeza que deseja apagar todos os registros de focos?")) {
      focos.forEach(foco => {
        map.removeLayer(foco.marcador);
      });
      focos.length = 0;
      atualizarContador();
    }
  }

  /**
   * INICIALIZA√á√ÉO
   */
  document.addEventListener('DOMContentLoaded', function() {
    // Carrega os tipos de focos no painel
    loadIncidentTypes();
    
    // Inicia o rel√≥gio
    setInterval(atualizarRelogio, 1000);
    atualizarRelogio();

    // Tenta obter a localiza√ß√£o do usu√°rio
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        iniciarMapa(pos.coords.latitude, pos.coords.longitude);
      }, err => {
        console.error("Erro de geolocaliza√ß√£o:", err);
        alert("N√£o foi poss√≠vel obter sua localiza√ß√£o. Por favor, verifique as permiss√µes de geolocaliza√ß√£o.");
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    } else {
      alert("Seu navegador n√£o suporta geolocaliza√ß√£o. O sistema n√£o funcionar√° corretamente.");
    }
  });
</script>
</body>
</html>